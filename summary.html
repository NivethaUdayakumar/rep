<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Department Cards (with w2ui popups)</title>

  <!-- If you already host w2ui-2.0 locally, use these two lines instead: -->
  <link rel="stylesheet" href="./w2ui-2.0.min.css" />
  <script src="./w2ui-2.0.min.js"></script>

  <style>
    :root{
      --bg:#f7f9fc; --ink:#0f172a; --muted:#475569; --card:#ffffff; --line:#e2e8f0;
      --accent:#2563eb; --good:#16a34a; --fair:#f59e0b; --poor:#dc2626;
      --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:20px 24px}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:10px}
    .toolbar input[type="search"], .toolbar select{
      padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink);
    }
    .grid{display:grid;gap:16px;padding:0 24px 24px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:16px 16px 12px;display:flex;flex-direction:column;gap:10px
    }
    .dept{font-weight:800;font-size:20px;letter-spacing:.2px}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{font-size:11px;font-weight:700;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);background:#f8fafc}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:center;border:1px solid var(--line);
        border-radius:10px;padding:8px 10px;background:#fafafa}
    .kv .key{color:var(--muted);font-weight:600}
    .kv .val{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:600}
    .kv.clickable{cursor:pointer;background:#f0f7ff;border-color:#cfe0ff}
    .kv.clickable:hover{outline:2px solid #cfe0ff}
    .scoreRow{display:flex;flex-direction:column;gap:8px;margin-top:2px}
    .scoreTop{display:flex;align-items:center;gap:10px}
    .scoreNum{font-weight:800}
    .indicator{font-size:12px;font-weight:800;border-radius:999px;padding:4px 10px;border:1px solid}
    .indicator.good{color:var(--good);border-color:var(--good);background:rgba(22,163,74,.08)}
    .indicator.fair{color:var(--fair);border-color:var(--fair);background:rgba(245,158,11,.10)}
    .indicator.poor{color:var(--poor);border-color:var(--poor);background:rgba(220,38,38,.10)}
    .bar{height:10px;border-radius:999px;background:#eef2f7;border:1px solid var(--line);overflow:hidden}
    .bar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa)}
    .footer{margin-top:6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <h1>Department Score Cards</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="Search departments…" />
    <select id="sort">
      <option value="dept-asc">Sort: Dept ↑</option>
      <option value="dept-desc">Sort: Dept ↓</option>
      <option value="score-desc" selected>Sort: Score ↓</option>
      <option value="score-asc">Sort: Score ↑</option>
      <option value="time-desc">Sort: Updated ↓</option>
      <option value="time-asc">Sort: Updated ↑</option>
    </select>
  </div>
</header>

<div id="grid" class="grid" role="list"></div>

<script>
/* ==================== REQUIRED JSON FORMAT ====================
{
  "dept_name": {
    "HeaderForCol2": "val2",
    "HeaderForCol5": "val3",
    "HeaderForCol6": "val5",
    "f1": "reports.html",
    "f2": "logs/log.txt",
    "f3": "",
    "updatedAt": "2025-09-29T12:34:56.789Z"
  },
  ...
}
The f1/f2/f3 are NOT displayed; clicking the corresponding header rows opens the linked file in a w2ui popup (showMax:true).
Mappings (fixed): f1→HeaderForCol2, f2→HeaderForCol5, f3→HeaderForCol6.
================================================================= */

// Demo data (add more departments as needed)
const data = {
  "dept_etc": {
    "HeaderForCol2": "Overall Summary",
    "HeaderForCol5": "Latest Log",
    "HeaderForCol6": "—",
    "f1": "report.html",
    "f2": "logs/log.txt",
    "f3": "",
    "updatedAt": "2025-09-29T12:34:56.789Z"
  },
  "dept_finance": {
    "HeaderForCol2": "Close Report",
    "HeaderForCol5": "Audit Log",
    "HeaderForCol6": "Variance View",
    "f1": "report.html",
    "f2": "logs/audit.txt",
    "f3": "report.html",
    "updatedAt": "2025-09-28T09:10:00.000Z"
  }
};

/* ==================== Scoring (kept simple here) ==================== */
const SCORERS = {
  "__default__": (s) => 50  // fixed neutral score for this format (can be replaced with your own logic)
};

/* ==================== Utilities ==================== */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function indicator(score){ if (score>=75) return {cls:'good',label:'Good'}; if (score>=50) return {cls:'fair',label:'Fair'}; return {cls:'poor',label:'Poor'}; }
function fmtTime(iso){ if(!iso) return '—'; const d=new Date(iso); return d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function scoreFor(stats){ const fn = SCORERS["__default__"]; return clamp(Math.round(fn(stats)),0,100); }

const LINK_PAIRS = [
  ["HeaderForCol2","f1"],
  ["HeaderForCol5","f2"],
  ["HeaderForCol6","f3"],
];

/** Build a map { displayKey -> url } for keys that have corresponding fN links */
function buildLinkMap(stats){
  const map = {};
  for (const [hdr, fx] of LINK_PAIRS){
    const url = stats[fx];
    if (stats[hdr] !== undefined && url && String(url).trim() !== "") {
      map[hdr] = String(url).trim();
    }
  }
  return map;
}

/** Convert stats to rows for display (hide f1..fN and updatedAt) */
function toRows(stats){
  const keys = Object.keys(stats).filter(k => !/^f\d+$/i.test(k) && k !== 'updatedAt');
  // Keep stable order but nudge "HeaderForCol2/5/6" to the top in numeric order 2,5,6
  const priority = { HeaderForCol2: 1, HeaderForCol5: 2, HeaderForCol6: 3 };
  keys.sort((a,b)=>{
    const pa = priority[a] ?? 999, pb = priority[b] ?? 999;
    if (pa !== pb) return pa - pb;
    return a.localeCompare(b);
  });
  return keys.map(k => ({ key:k, val:String(stats[k]) }));
}

/* ==================== Transform ==================== */
function normalizeEntries(obj){
  return Object.entries(obj).map(([dept, stats])=>{
    const score = scoreFor(stats);
    return {
      dept,
      rows: toRows(stats),
      linkByKey: buildLinkMap(stats),
      updatedAt: stats.updatedAt || null,
      updatedNum: stats.updatedAt ? Date.parse(stats.updatedAt) : 0,
      score,
      ind: indicator(score)
    };
  });
}

let entries = normalizeEntries(data);

/* ==================== Sorting / Search ==================== */
const gridEl = document.getElementById('grid');
const qEl = document.getElementById('q');
const sortEl = document.getElementById('sort');

function applySort(arr, mode){
  const a = [...arr];
  if (mode === 'dept-asc')  a.sort((x,y)=>x.dept.localeCompare(y.dept, undefined, {numeric:true}));
  if (mode === 'dept-desc') a.sort((x,y)=>y.dept.localeCompare(x.dept, undefined, {numeric:true}));
  if (mode === 'score-desc')a.sort((x,y)=>y.score - x.score);
  if (mode === 'score-asc') a.sort((x,y)=>x.score - y.score);
  if (mode === 'time-desc') a.sort((x,y)=>y.updatedNum - x.updatedNum);
  if (mode === 'time-asc')  a.sort((x,y)=>x.updatedNum - y.updatedNum);
  return a;
}

/* ==================== w2ui popup helper ==================== */
function openPopup(url, title){
  const body = `
    <div style="width:100%;height:100%;padding:0;margin:0;">
      <iframe src="${url}" style="border:0;width:100%;height:100%;"></iframe>
    </div>`;
  if (window.w2popup && typeof w2popup.open === 'function') {
    w2popup.open({
      title: title || 'Preview',
      width: Math.min(window.innerWidth*0.9, 1200),
      height: Math.min(window.innerHeight*0.9, 800),
      showMax: true,
      modal: true,
      body
    });
  } /*else {
    // Fallback if w2ui is not present
    const w = window.open(url, '_blank', 'noopener,noreferrer');
    if (!w) alert('Popup blocked. Please allow popups for this site.');
  }*/
}

/* ==================== Render ==================== */
function render(){
  const query = (qEl.value || '').trim().toLowerCase();
  const mode = sortEl.value;
  const sorted = applySort(entries, mode);

  gridEl.innerHTML = '';
  for (const e of sorted) {
    if (query && !e.dept.toLowerCase().includes(query)) continue;

    const card = document.createElement('article');
    card.className = 'card';
    card.setAttribute('role','listitem');
    card.innerHTML = `
      <div class="dept" title="${e.dept}">${e.dept}</div>
      <div class="meta">
        <span class="badge">Fields: ${e.rows.length}</span>
      </div>

      <div class="scoreRow">
        <div class="scoreTop">
          <div class="scoreNum">${e.score}/100</div>
          <span class="indicator ${e.ind.cls}">${e.ind.label}</span>
        </div>
        <div class="bar" aria-label="Score progress"><span style="width:${e.score}%"></span></div>
      </div>

      <div class="body"></div>
      <div class="footer">
        <span>Last updated: ${fmtTime(e.updatedAt)}</span>
      </div>
    `;

    const body = card.querySelector('.body');
    for (const r of e.rows) {
      const hasLink = Object.prototype.hasOwnProperty.call(e.linkByKey, r.key);
      const row = document.createElement('div');
      row.className = 'kv' + (hasLink ? ' clickable' : '');
      row.innerHTML = `
        <div class="key">${r.key}</div>
        <div class="val" title="${r.val}">${r.val}</div>
      `;
      if (hasLink) {
        row.title = `Open: ${e.linkByKey[r.key]}`;
        row.addEventListener('click', () => openPopup(e.linkByKey[r.key], `${e.dept} — ${r.key}`));
        row.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            openPopup(e.linkByKey[r.key], `${e.dept} — ${r.key}`);
          }
        });
        row.setAttribute('tabindex','0');
        row.setAttribute('role','button');
        row.setAttribute('aria-label', `Open ${r.key}`);
      }
      body.appendChild(row);
    }

    gridEl.appendChild(card);
  }

  if (!gridEl.children.length) {
    const empty = document.createElement('div');
    empty.style.color = 'var(--muted)';
    empty.textContent = 'No departments match your search.';
    gridEl.appendChild(empty);
  }
}

qEl.addEventListener('input', render);
sortEl.addEventListener('change', render);
render();

/* ===== Example: re-normalize after loading real data =====
fetch('/api/summary').then(r=>r.json()).then(obj=>{
  entries = normalizeEntries(obj);
  render();
}).catch(console.error);
*/
</script>
</body>
</html>
