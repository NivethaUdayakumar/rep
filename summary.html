<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Department Cards (w2ui popups, order preserved)</title>

  <!-- Use your local copies of w2ui 2.0 -->
  <link rel="stylesheet" href="w2ui-2.0.min.css">
  <script src="w2ui-2.0.min.js"></script>

  <style>
    :root{
      --bg:#f7f9fc; --ink:#0f172a; --muted:#475569; --card:#ffffff; --line:#e2e8f0;
      --accent:#2563eb; --good:#16a34a; --fair:#f59e0b; --poor:#dc2626;
      --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:20px 24px}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:10px}
    .toolbar input[type="search"]{
      padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink);
    }
    .grid{display:grid;gap:16px;padding:0 24px 24px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:16px 16px 12px;display:flex;flex-direction:column;gap:10px
    }
    .dept{font-weight:800;font-size:20px;letter-spacing:.2px}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{font-size:11px;font-weight:700;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);background:#f8fafc}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:center;border:1px solid var(--line);
        border-radius:10px;padding:8px 10px;background:#fafafa}
    .kv .key{color:var(--muted);font-weight:600}
    .kv .val{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:600}
    .kv.clickable{cursor:pointer;background:#f0f7ff;border-color:#cfe0ff}
    .kv.clickable:hover{outline:2px solid #cfe0ff}
    .scoreRow{display:flex;flex-direction:column;gap:8px;margin-top:2px}
    .scoreTop{display:flex;align-items:center;gap:10px}
    .scoreNum{font-weight:800}
    .indicator{font-size:12px;font-weight:800;border-radius:999px;padding:4px 10px;border:1px solid}
    .indicator.good{color:var(--good);border-color:var(--good);background:rgba(22,163,74,.08)}
    .indicator.fair{color:var(--fair);border-color:var(--fair);background:rgba(245,158,11,.10)}
    .indicator.poor{color:var(--poor);border-color:var(--poor);background:rgba(220,38,38,.10)}
    .bar{height:10px;border-radius:999px;background:#eef2f7;border:1px solid var(--line);overflow:hidden}
    .bar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa)}
    .footer{margin-top:6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <h1>Department Score Cards</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="Search departments…" />
  </div>
</header>

<div id="grid" class="grid" role="list"></div>

<script>
/* ==================== REQUIRED JSON FORMAT (order preserved) ====================
Top-level object keys are department names, in the display order.
Each department object:
- Several *display headers* (any unique keys) with string/number values.
- The same number of link keys named f1, f2, f3, ... in insertion order.
- updatedAt (optional).

Display header i maps to link fi (1-based) by position of appearance.
f* keys are NOT displayed; clicking the corresponding display row opens its link in a w2ui popup.
=============================================================================== */

const data = {
  "dept_etc": {
    "HeaderForCol2": "Overall Summary",
    "HeaderForCol5": "Latest Log",
    "HeaderForCol6": "—",
    "f1": "reports/summary.html",
    "f2": "logs/log.txt",
    "f3": "",
    "updatedAt": "2025-09-29T12:34:56.789Z"
  },
  "dept_finance": {
    "Close Report": "FY25-Q3",
    "Audit Trail": "Complete",
    "Variance View": "Ready",
    "f1": "reports/close.html",
    "f2": "logs/audit.txt",
    "f3": "reports/variance.html",
    "updatedAt": "2025-09-28T09:10:00.000Z"
  }
};

/* ==================== Scoring (simple placeholder) ==================== */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function scoreFor(stats){
  // Example neutral score; swap with your own logic if needed.
  return 60;
}
function indicator(score){ if (score>=75) return {cls:'good',label:'Good'}; if (score>=50) return {cls:'fair',label:'Fair'}; return {cls:'poor',label:'Poor'}; }
function fmtTime(iso){ if(!iso) return '—'; const d=new Date(iso); return d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }

/* ==================== Mapping & normalization ==================== */
/** Returns [{ key, val, link|null }...] in the exact order they appeared in the JSON. */
function rowsWithLinks(stats){
  const displayKeys = [];
  const linkKeys = [];

  // Collect keys in insertion order
  for (const k of Object.keys(stats)) {
    if (k === 'updatedAt') continue;
    if (/^f\d+$/i.test(k)) linkKeys.push(k);
    else displayKeys.push(k);
  }

  const n = Math.min(displayKeys.length, linkKeys.length);
  const out = [];
  for (let i = 0; i < displayKeys.length; i++) {
    const key = displayKeys[i];
    const val = String(stats[key]);
    const link = (i < n) ? String(stats[linkKeys[i]] ?? '').trim() : '';
    out.push({ key, val, link: link || null });
  }
  return out;
}

function normalizeEntries(dataObj){
  // Object.entries preserves insertion order of top-level JSON object
  return Object.entries(dataObj).map(([dept, stats]) => {
    const rows = rowsWithLinks(stats);         // ordered rows with link mapping
    const score = clamp(Math.round(scoreFor(stats)), 0, 100);
    return {
      dept,
      rows,
      updatedAt: stats.updatedAt || null,
      score,
      ind: indicator(score)
    };
  });
}

let entries = normalizeEntries(data);

/* ==================== w2ui popup helper (no window.open fallback) ==================== */
function openPopup(url, title){
  const safe = String(url || '').trim();
  if (!safe) return;

  const body = `
    <div style="width:100%;height:100%;padding:0;margin:0;">
      <iframe src="${safe}" style="border:0;width:100%;height:100%;"></iframe>
    </div>`;

  w2popup.open({
    title: title || 'Preview',
    width: Math.min(window.innerWidth*0.9, 1200),
    height: Math.min(window.innerHeight*0.9, 800),
    showMax: true,
    modal: true,
    body
  });
}

/* ==================== Render (preserve order; no sorting) ==================== */
const gridEl = document.getElementById('grid');
const qEl = document.getElementById('q');

function render(){
  const query = (qEl.value || '').trim().toLowerCase();

  gridEl.innerHTML = '';
  for (const e of entries) {
    if (query && !e.dept.toLowerCase().includes(query)) continue;

    const card = document.createElement('article');
    card.className = 'card';
    card.setAttribute('role','listitem');
    card.innerHTML = `
      <div class="dept" title="${e.dept}">${e.dept}</div>
      <div class="meta">
        <span class="badge">Fields: ${e.rows.length}</span>
      </div>

      <div class="scoreRow">
        <div class="scoreTop">
          <div class="scoreNum">${e.score}/100</div>
          <span class="indicator ${e.ind.cls}">${e.ind.label}</span>
        </div>
        <div class="bar" aria-label="Score progress"><span style="width:${e.score}%"></span></div>
      </div>

      <div class="body"></div>
      <div class="footer">
        <span>Last updated: ${fmtTime(e.updatedAt)}</span>
      </div>
    `;

    const body = card.querySelector('.body');
    for (const r of e.rows) {
      const row = document.createElement('div');
      row.className = 'kv' + (r.link ? ' clickable' : '');
      row.innerHTML = `
        <div class="key">${r.key}</div>
        <div class="val" title="${r.val}">${r.val}</div>
      `;
      if (r.link) {
        row.title = `Open: ${r.link}`;
        row.tabIndex = 0;
        row.setAttribute('role','button');
        row.setAttribute('aria-label', `Open ${r.key}`);
        row.addEventListener('click', () => openPopup(r.link, `${e.dept} — ${r.key}`));
        row.addEventListener('keydown', ev => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openPopup(r.link, `${e.dept} — ${r.key}`); }
        });
      }
      body.appendChild(row);
    }

    gridEl.appendChild(card);
  }

  if (!gridEl.children.length) {
    const empty = document.createElement('div');
    empty.style.color = 'var(--muted)';
    empty.textContent = 'No departments match your search.';
    gridEl.appendChild(empty);
  }
}

qEl.addEventListener('input', render);
render();

/* ===== Example: load from API while preserving order =====
fetch('/api/summary')
  .then(r => r.json())
  .then(obj => { entries = normalizeEntries(obj); render(); })
  .catch(console.error);
*/
</script>
</body>
</html>
