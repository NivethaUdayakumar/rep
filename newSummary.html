<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Department and Unit Summary</title>

  <!-- w2ui 2.0 local files -->
  <link rel="stylesheet" href="w2ui-2.0.min.css">
  <script src="w2ui-2.0.min.js"></script>

  <style>
    :root{
      --bg:#f7f9fc; --ink:#0f172a; --muted:#475569; --card:#ffffff; --line:#e2e8f0;
      --good:#16a34a; --fair:#f59e0b; --poor:#dc2626;
      --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:20px 24px}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:10px}
    .toolbar input[type="search"]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink)}

    .grid{display:grid;gap:16px;padding:0 24px 24px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:16px 16px 12px;display:flex;flex-direction:column;gap:10px;position:relative
    }
    .dept{font-weight:800;font-size:20px;letter-spacing:.2px;padding-right:120px}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{font-size:11px;font-weight:700;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);background:#f8fafc}

    .scoreWrap{position:absolute;top:12px;right:12px;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .scoreVal{font-weight:900;font-size:28px;line-height:1}
    .scoreVal small{font-size:12px;color:var(--muted);margin-left:2px}
    .scoreBadge{font-size:11px;font-weight:800;border-radius:999px;padding:2px 8px;border:1px solid var(--line);background:#fff}
    .scoreGood{color:var(--good);border-color:var(--good)}
    .scoreFair{color:var(--fair);border-color:var(--fair)}
    .scorePoor{color:var(--poor);border-color:var(--poor)}

    .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:center;border:1px solid var(--line);
        border-radius:10px;padding:8px 10px;background:#fafafa}
    .kv .key{color:var(--muted);font-weight:600}
    .kv .val{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
    .kv.clickable{cursor:pointer;background:#f0f7ff;border-color:#cfe0ff}
    .kv.clickable:hover{outline:2px solid #cfe0ff}

    .footer{margin-top:6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}

    .popup-wrap{padding:0;height:100%}
    .unit-grid{display:grid;gap:12px;padding:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .unit-title{font-weight:700;margin-bottom:6px;padding-right:90px;position:relative}
    .unit-score{position:absolute;top:0;right:0;display:flex;flex-direction:column;align-items:flex-end;gap:2px}
    .unit-score .sv{font-weight:900}
    .unit-score .sb{font-size:10px;padding:1px 6px;border-radius:999px;border:1px solid var(--line)}
    .unit-updated{font-size:12px;color:var(--muted);margin-top:6px}

    .bar{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid var(--line);gap:8px}
    .navbtn{padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
    .navbtn:disabled{opacity:.4;cursor:not-allowed}
    .filetitle{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}

    .viewer{width:100%;height:calc(100% - 44px)}
    .viewer > .fit{width:100%;height:100%}
    .viewer pre{margin:0;padding:12px;height:100%;overflow:auto;white-space:pre-wrap}
    .viewer .imgbox{display:flex;align-items:center;justify-content:center;height:100%;background:#fff}
    .viewer .imgbox img{max-width:100%;max-height:100%}
    .viewer .grid-host{height:100%}
    .viewer .msg{padding:12px;color:var(--muted)}
    .info{color:var(--muted);padding:16px 24px}
    .skeleton{height:120px;border-radius:14px;background:linear-gradient(90deg,#f1f5f9, #e2e8f0, #f1f5f9);animation:sh 1.2s infinite}
    @keyframes sh{0%{background-position:-200% 0}100%{background-position:200% 0}}
  </style>
</head>
<body>
<header>
  <h1>Department Summary</h1>
  <div class="toolbar">
    <input id="q" type="search" placeholder="Search departments" />
  </div>
</header>

<div id="grid" class="grid" role="list"></div>
<div id="state" class="info"></div>

<script>
/* ========= Config ========= */
const ENDPOINT_URL = '/api/summary';

/* ========= State ========= */
let data = {};
let groups = new Map();
let orderedDepts = [];

/* ========= Utils ========= */
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
function fmt1(n){ return (Math.round(n*10)/10).toFixed(1); }
function fmtNum(n){ const v = Number(n); return Number.isFinite(v) ? v.toLocaleString() : String(n); }
function fmtTime(iso){ if(!iso) return 'NA'; const d=new Date(iso); return d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function daysDiff(a,b){ return Math.abs((a-b)/(1000*60*60*24)); }
function splitKey(k){ const i=k.indexOf('_'); return i<0?{dept:k,unit:''}:{dept:k.slice(0,i),unit:k.slice(i+1)}; }
function toNumber(x){ if (x==null) return NaN; const s=String(x).replace(/,/g,''); const m=s.match(/-?\d+(\.\d+)?/); return m?parseFloat(m[0]):NaN; }
function fileExt(url){ const q=url.split('?')[0].split('#')[0]; const i=q.lastIndexOf('.'); return i>=0 ? q.slice(i+1).toLowerCase() : ''; }

function rowsWithLinks(stats){
  const displayKeys = [], linkKeys = [];
  for (const k of Object.keys(stats)) {
    if (k === 'updatedAt') continue;
    if (/^f\d+$/i.test(k)) linkKeys.push(k); else displayKeys.push(k);
  }
  const out = []; const pairs = Math.min(displayKeys.length, linkKeys.length);
  for (let i=0;i<displayKeys.length;i++){
    const key = displayKeys[i];
    const val = String(stats[key]);
    const link = i < pairs ? String(stats[linkKeys[i]] || '').trim() : '';
    out.push({ key, val, link: link || null });
  }
  return out;
}

/* ========= Scoring per dept ========= */
function computeScoreGeneric(stats){
  const keys = Object.keys(stats).filter(k => k !== 'updatedAt' && !/^f\d+$/i.test(k));
  const n = keys.length; if (!n) return 0;
  let filled = 0, penalty = 0;
  const errRx = /(err|error|fail|failed|timeout|na|n\/a|missing|unknown|invalid)/i;
  for (const k of keys){
    const s = (stats[k] ?? '').toString().trim();
    if (s && s.toLowerCase() !== 'na' && s.toLowerCase() !== 'n/a') filled++;
    if (errRx.test(s)) penalty += 0.2;
  }
  penalty = Math.min(penalty, 0.6);
  const completeness = filled / n;
  let freshness = 0;
  const t = Date.parse(stats.updatedAt || '');
  if (!isNaN(t)){
    const d = daysDiff(new Date(), t);
    freshness = d <= 7 ? 0.1 : d <= 30 ? 0.05 : 0;
  }
  return Number(fmt1(clamp(completeness - penalty + freshness, 0, 1) * 20));
}
function computeScoreDept1(stats){
  const numKeys = ['a','b','c'];
  let numFilled=0, numCount=0;
  numKeys.forEach(k=>{ if (k in stats){ numCount++; if (Number.isFinite(toNumber(stats[k]))) numFilled++; }});
  const numerics = numCount ? numFilled/numCount : 0;
  let okBonus = 0; ['d','e','f'].forEach(k=>{ if (k in stats && String(stats[k]).toLowerCase()==='ok') okBonus+=0.03; });
  okBonus = Math.min(okBonus, 0.09);
  let freshness = 0;
  const t = Date.parse(stats.updatedAt || '');
  if (!isNaN(t)){ const d = daysDiff(new Date(), t); freshness = d<=7?0.08:d<=30?0.04:0; }
  const base = 0.5*numerics + 0.5*(computeScoreGeneric(stats)/20);
  return Number(fmt1(clamp(base + okBonus + freshness, 0, 1) * 20));
}
function computeScoreDept2(stats){
  const nums=['x','y','z'].map(k=>toNumber(stats[k])).filter(v=>Number.isFinite(v));
  const avgNorm = nums.length ? Math.min(1, Math.max(0, nums.reduce((a,b)=>a+b,0)/(nums.length*100))) : 0;
  let textPenalty=0; ['note','flag','meta'].forEach(k=>{ if (k in stats && String(stats[k]).toLowerCase()!=='ok') textPenalty+=0.05; });
  textPenalty = Math.min(textPenalty, 0.15);
  const generic = computeScoreGeneric(stats)/20;
  return Number(fmt1(clamp(0.6*generic + 0.4*avgNorm - textPenalty, 0, 1)*20));
}
const unitScoreFns = { '*': computeScoreGeneric, 'dept1': computeScoreDept1, 'dept2': computeScoreDept2 };
function computeUnitScoreForDept(dept, stats){ const fn = Object.prototype.hasOwnProperty.call(unitScoreFns, dept)?unitScoreFns[dept]:unitScoreFns['*']; return fn(stats, dept); }
function scoreClass(score){ if (score>=14) return {text:'Good', cls:'scoreGood'}; if (score>=10) return {text:'Fair', cls:'scoreFair'}; return {text:'Poor', cls:'scorePoor'}; }

/* ========= Grouping ========= */
function buildGroups(obj){ const g=new Map(); for (const [k,v] of Object.entries(obj)){ const {dept,unit}=splitKey(k); if(!g.has(dept)) g.set(dept,[]); g.get(dept).push({unit,stats:v,key:k}); } return g; }
function pickRepresentative(units){ let best=null, bestTime=-Infinity; for (const u of units){ const t=Date.parse(u.stats.updatedAt||''); if(!isNaN(t) && t>bestTime){best=u;bestTime=t;} } return best||units[0]; }

/* ========= Popup helpers ========= */
function popupSetTitle(text){
  if (window.w2popup && typeof w2popup.title === 'function') w2popup.title(text);
  else {
    const tEl = document.querySelector('#w2ui-popup .w2ui-popup-title'); if (tEl) tEl.textContent = text;
  }
}
function popupSetBody(html, onReady){
  const body = document.querySelector('#w2ui-popup .w2ui-popup-body');
  if (body){
    body.innerHTML = html;
    setTimeout(() => { if (typeof onReady === 'function') onReady(); }, 0);
  }
}

/* ========= Multi viewer in popup: supports many file types =========
   Types:
   html, htm, pdf use iframe
   csv uses w2ui grid
   json pretty prints
   txt md logs show in pre
   images show in img container
   others show a message with a download link and try iframe fallback
*/
function destroyGridIfExists(name){
  try{ if (w2ui[name]) { w2ui[name].destroy(); } }catch(e){}
}

function parseCSV(text){
  // light RFC4180 parser
  const rows = [];
  let cur = '', row = [], i=0, inQ=false;
  while (i < text.length){
    const c = text[i];
    if (inQ){
      if (c === '"'){
        if (text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inQ = false; i++; continue;
      } else { cur += c; i++; continue; }
    } else {
      if (c === '"'){ inQ = true; i++; continue; }
      if (c === ','){ row.push(cur); cur=''; i++; continue; }
      if (c === '\r'){ i++; continue; }
      if (c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue; }
      cur += c; i++; continue;
    }
  }
  row.push(cur); rows.push(row);
  // trim trailing empty last row
  if (rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==='') rows.pop();
  return rows;
}

function csvToGridDef(rows){
  const headers = rows[0] || [];
  const cols = headers.map((h,idx)=>({ field: `c${idx}`, text: h || `col${idx+1}`, size: '120px', resizable: true }));
  const records = rows.slice(1).map((r,ri)=>{
    const rec = { recid: ri+1 };
    cols.forEach((c,ci)=>{ rec[c.field] = r[ci] ?? ''; });
    return rec;
  });
  return { columns: cols, records };
}

function renderFileViewerInPopup(files, startIndex, titlePrefix, onBack){
  const safeFiles = files.filter(x => x && x.trim());
  if (!safeFiles.length) return;
  let idx = Math.max(0, Math.min(startIndex || 0, safeFiles.length - 1));

  const html = `
    <div class="bar">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="backBtn" class="navbtn">Back</button>
        <button id="navPrev" class="navbtn">Prev</button>
        <button id="navNext" class="navbtn">Next</button>
      </div>
      <div class="filetitle" id="fileTitle"></div>
    </div>
    <div id="viewer" class="viewer"></div>
  `;

  async function setFrame(){
    const url = safeFiles[idx];
    popupSetTitle(`${titlePrefix} | ${idx+1} of ${safeFiles.length}`);
    const t = document.getElementById('fileTitle');
    const viewer = document.getElementById('viewer');
    if (!viewer) return;

    if (t) t.textContent = url;
    viewer.innerHTML = '';
    destroyGridIfExists('csvGrid');

    const ext = fileExt(url);

    // csv via fetch then w2ui grid
    if (ext === 'csv'){
      const host = document.createElement('div');
      host.className = 'fit grid-host';
      host.id = 'csv-host';
      viewer.appendChild(host);

      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const rows = parseCSV(text);
        const { columns, records } = csvToGridDef(rows);
        new w2grid({
          name: 'csvGrid',
          box: host,
          columns,
          records,
          show: { toolbar: true, footer: true, toolbarReload: false }
        });
      } catch (e){
        viewer.innerHTML = `<div class="msg">Failed to load CSV. ${e.message}</div>`;
      }
      return;
    }

    // json pretty print
    if (ext === 'json'){
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const obj = await res.json();
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(obj, null, 2);
        viewer.appendChild(pre);
      } catch(e){
        viewer.innerHTML = `<div class="msg">Failed to load JSON. ${e.message}</div>`;
      }
      return;
    }

    // text or markdown
    if (ext === 'txt' || ext === 'log' || ext === 'md'){
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const pre = document.createElement('pre');
        pre.textContent = text;
        viewer.appendChild(pre);
      } catch(e){
        viewer.innerHTML = `<div class="msg">Failed to load text. ${e.message}</div>`;
      }
      return;
    }

    // images
    if (['png','jpg','jpeg','gif','webp','svg'].includes(ext)){
      const box = document.createElement('div');
      box.className = 'imgbox fit';
      const img = document.createElement('img');
      img.alt = url;
      img.src = url;
      box.appendChild(img);
      viewer.appendChild(box);
      return;
    }

    // pdf and html family via iframe
    if (['pdf','html','htm'].includes(ext)){
      const iframe = document.createElement('iframe');
      iframe.className = 'fit';
      iframe.src = url;
      iframe.setAttribute('referrerpolicy','no-referrer');
      iframe.setAttribute('sandbox','allow-forms allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts');
      viewer.appendChild(iframe);
      return;
    }

    // default: try iframe, else show download link
    const iframe = document.createElement('iframe');
    iframe.className = 'fit';
    iframe.src = url;
    iframe.onload = () => {};
    iframe.onerror = () => {
      viewer.innerHTML = `<div class="msg">Preview not available. <a href="${url}" target="_blank" rel="noopener">Open externally</a></div>`;
    };
    viewer.appendChild(iframe);
  }

  popupSetBody(html, () => {
    document.getElementById('backBtn').addEventListener('click', () => { if (typeof onBack === 'function') onBack(); });
    document.getElementById('navPrev').addEventListener('click', () => { if (idx>0){ idx--; setFrame(); }});
    document.getElementById('navNext').addEventListener('click', () => { if (idx<safeFiles.length-1){ idx++; setFrame(); }});
    setFrame();
  });
}

/* ========= Second level ========= */
function renderUnitsInPopup(dept, units, hideKeys){
  const wrap = document.createElement('div');
  wrap.className = 'popup-wrap';
  wrap.innerHTML = `
    <div class="bar">
      <div style="font-weight:800">${dept} units</div>
    </div>
    <div class="unit-grid" id="unitGrid"></div>`;
  popupSetBody(wrap.outerHTML, () => {
    const grid = document.getElementById('unitGrid');
    units.forEach((u) => {
      const allRows = rowsWithLinks(u.stats);
      const rows = allRows.filter(r => !hideKeys.has(r.key));

      const uScore = computeUnitScoreForDept(dept, u.stats);
      const badge = scoreClass(uScore);

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <div class="unit-title">
          ${u.unit || '(unit)'}
          <div class="unit-score">
            <div class="sv">${fmt1(uScore)}<small>/20</small></div>
            <div class="sb ${badge.cls}">${badge.text}</div>
          </div>
        </div>
        <div class="body"></div>
        <div class="unit-updated">Updated ${fmtTime(u.stats.updatedAt)}</div>
      `;
      const bodyEl = card.querySelector('.body');

      const unitLinks = rows.map(r => r.link).filter(Boolean);
      rows.forEach((r) => {
        const row = document.createElement('div');
        const clickable = !!r.link;
        row.className = 'kv' + (clickable ? ' clickable' : '');
        row.innerHTML = `
          <div class="key">${r.key}</div>
          <div class="val" title="${r.val}">${r.val}</div>
        `;
        if (clickable) {
          row.addEventListener('click', () => {
            const startIdx = Math.max(0, unitLinks.indexOf(r.link));
            renderFileViewerInPopup(unitLinks, startIdx, `${dept} ${u.unit}`, () => {
              renderUnitsInPopup(dept, units, hideKeys);
              popupSetTitle(`${dept} details`);
            });
          });
        }
        bodyEl.appendChild(row);
      });

      grid.appendChild(card);
    });
  });
  popupSetTitle(`${dept} details`);
}

function openUnitsPopup(dept, units, hideKeys){
  w2popup.open({
    title: `${dept} details`,
    width: Math.min(window.innerWidth*0.95, 1280),
    height: Math.min(window.innerHeight*0.95, 860),
    showMax: true,
    modal: true,
    body: '<div class="popup-wrap"></div>',
    onOpen(evt){ evt.onComplete = () => renderUnitsInPopup(dept, units, hideKeys || new Set()); }
  });
}

/* ========= First level render ========= */
const gridEl = document.getElementById('grid');
const qEl = document.getElementById('q');
const stateEl = document.getElementById('state');

function scoreBadgeFor(value){
  const s = scoreClass(value);
  return `<div class="scoreWrap">
            <div class="scoreVal">${fmt1(value)}<small>/20</small></div>
            <div class="scoreBadge ${s.cls}">${s.text}</div>
          </div>`;
}

function render(){
  const query = (qEl.value || '').trim().toLowerCase();
  gridEl.innerHTML = '';
  stateEl.textContent = '';

  if (!orderedDepts.length){
    stateEl.textContent = 'No data.';
    return;
  }

  for (const dept of orderedDepts){
    if (query && !dept.toLowerCase().includes(query)) continue;

    const units = groups.get(dept) || [];
    const now = new Date();
    const updatedCount = units.reduce((acc, u) => {
      const t = Date.parse(u.stats.updatedAt || '');
      if (!isNaN(t) && daysDiff(now, t) <= 7.0) acc++;
      return acc;
    }, 0);

    const unitScores = units.map(u => computeUnitScoreForDept(dept, u.stats));
    const avgScore = unitScores.length ? unitScores.reduce((a,b)=>a+b,0)/unitScores.length : 0;
    const avgScoreClamped = Number(fmt1(clamp(avgScore, 0, 20)));

    const rep = pickRepresentative(units);
    const repRows = rowsWithLinks(rep.stats);
    const repLastThree = repRows.slice(-3);

    const sums = [0,0,0];
    const sumLinks = [[],[],[]];
    const hideKeys = new Set(repLastThree.map(r => r.key));

    units.forEach(u => {
      const rows = rowsWithLinks(u.stats);
      const last3 = rows.slice(-3);
      for (let i=0;i<3;i++){
        const r = last3[i]; if (!r) continue;
        const num = toNumber(r.val); if (Number.isFinite(num)) sums[i] += num;
        if (r.link) sumLinks[i].push(r.link);
      }
    });

    const card = document.createElement('article');
    card.className = 'card';
    card.setAttribute('role','listitem');
    card.innerHTML = `
      <div class="dept" title="${dept}">${dept}</div>
      ${scoreBadgeFor(avgScoreClamped)}
      <div class="meta">
        <span class="badge">Units: ${units.length}</span>
        <span class="badge">Rep unit: ${rep.unit || '(unit)'}</span>
      </div>
      <div class="body"></div>
      <div class="footer">
        <button class="navbtn" id="open-${dept}">Open units</button>
        <span>Rep updated ${fmtTime(rep.stats.updatedAt)}</span>
      </div>
    `;

    const body = card.querySelector('.body');

    const row1 = document.createElement('div');
    row1.className = 'kv';
    row1.innerHTML = `
      <div class="key">Units updated last 7 days</div>
      <div class="val">${updatedCount}</div>
    `;
    body.appendChild(row1);

    repLastThree.forEach((r, idx) => {
      const row = document.createElement('div');
      const linksForIdx = sumLinks[idx];
      const clickable = linksForIdx.length > 0;
      row.className = 'kv' + (clickable ? ' clickable' : '');
      row.innerHTML = `
        <div class="key">Sum of ${r.key}</div>
        <div class="val" title="${sums[idx]}">${fmtNum(sums[idx])}</div>
      `;
      if (clickable){
        row.addEventListener('click', () => {
          w2popup.open({
            title: `${dept} aggregated`,
            width: Math.min(window.innerWidth*0.9, 1200),
            height: Math.min(window.innerHeight*0.9, 800),
            showMax: true,
            modal: true,
            body: '<div class="popup-wrap"></div>',
            onOpen(e){
              e.onComplete = () => {
                renderFileViewerInPopup(linksForIdx, 0, `${dept} ${r.key}`, () => { w2popup.close(); });
              };
            }
          });
        });
      }
      body.appendChild(row);
    });

    card.querySelector(`#open-${CSS.escape(dept)}`).addEventListener('click', () => openUnitsPopup(dept, units, hideKeys));

    gridEl.appendChild(card);
  }

  if (!gridEl.children.length){
    stateEl.textContent = 'No departments match your search.';
  }
}

/* ========= Fetch and boot ========= */
async function loadData(){
  stateEl.textContent = 'Loadingâ€¦';
  gridEl.innerHTML = '';
  for (let i=0;i<3;i++){ const sk=document.createElement('div'); sk.className='skeleton'; gridEl.appendChild(sk); }

  try{
    const res = await fetch(ENDPOINT_URL, { headers: { 'Accept': 'application/json' }});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const obj = await res.json();
    if (obj && typeof obj === 'object'){
      data = obj;
      groups = buildGroups(data);
      orderedDepts = Array.from(groups.keys());
      gridEl.innerHTML = '';
      stateEl.textContent = '';
      render();
    } else {
      throw new Error('Invalid payload. Expect object of { "dept_unit": { ... } }');
    }
  } catch (err){
    console.error(err);
    gridEl.innerHTML = '';
    stateEl.textContent = `Failed to load data: ${err.message}`;
  }
}

document.getElementById('q').addEventListener('input', render);
loadData();
</script>
</body>
</html>
